<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تتبع النوم</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; margin: 0; padding: 1em; }
  h1 { text-align: center; color: #2c3e50; }
  label { display: block; margin: 0.5em 0 0.2em; }
  input[type=time], textarea, select { width: 100%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; }
  button { background: #3498db; color: white; border: none; padding: 0.7em 1.2em; margin: 0.5em 0; border-radius: 4px; cursor: pointer; }
  button:hover { background: #2980b9; }
  #sleepResult, #sleepAdvice { margin-top: 1em; font-weight: bold; }
  #logTable { width: 100%; border-collapse: collapse; margin-top: 1em; }
  #logTable th, #logTable td { border: 1px solid #ddd; padding: 0.5em; text-align: center; }
  #logTable th { background: #2980b9; color: white; }
  textarea { resize: vertical; }
  .btn-group { margin-top: 1em; display: flex; gap: 0.5em; flex-wrap: wrap; }
</style>
</head>
<body>

<h1>تتبع النوم</h1>

<label for="sleepTime">وقت النوم:</label>
<input type="time" id="sleepTime" />

<label for="wakeTime">وقت الاستيقاظ:</label>
<input type="time" id="wakeTime" />

<label for="dailyNotes">ملاحظات اليوم:</label>
<textarea id="dailyNotes" rows="4" placeholder="اكتب ملاحظاتك هنا..."></textarea>

<div class="btn-group">
  <button onclick="saveRecord()">حفظ البيانات</button>
  <button onclick="calculateSleep()">احسب مدة النوم والنصائح</button>
  <button onclick="exportNotes()">تصدير الملاحظات</button>
  <button onclick="deleteTodayNotes()">حذف ملاحظات اليوم</button>
  <button onclick="deleteAllNotes()">حذف جميع الملاحظات</button>
</div>

<div id="sleepResult"></div>
<div id="sleepAdvice"></div>

<label for="viewRange">عدد الأيام للعرض في السجل:</label>
<select id="viewRange" onchange="renderLog()">
  <option value="7">7 أيام</option>
  <option value="14">14 يومًا</option>
  <option value="30">30 يومًا</option>
</select>

<table id="logTable">
  <thead>
    <tr>
      <th>التاريخ</th>
      <th>وقت النوم</th>
      <th>وقت الاستيقاظ</th>
      <th>ساعات النوم</th>
      <th>ملاحظات</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const DB_NAME = 'SleepTrackerDB';
  const STORE_NAME = 'sleepRecords';
  let db;

  // فتح أو إنشاء قاعدة بيانات IndexedDB
  function openDB() {
    return new Promise((resolve, reject) => {
      if (db) return resolve(db);
      const request = indexedDB.open(DB_NAME, 1);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        db = request.result;
        resolve(db);
      };
      request.onupgradeneeded = (event) => {
        db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const store = db.createObjectStore(STORE_NAME, { keyPath: 'date' });
          store.createIndex('date', 'date', { unique: true });
        }
      };
    });
  }

  // حفظ السجل اليومي
  async function saveRecord() {
    const sleepTime = document.getElementById('sleepTime').value;
    const wakeTime = document.getElementById('wakeTime').value;
    const notes = document.getElementById('dailyNotes').value.trim();
    if (!sleepTime || !wakeTime) {
      alert('يرجى إدخال وقت النوم ووقت الاستيقاظ.');
      return;
    }
    const today = new Date().toISOString().slice(0, 10);
    const [sleepH, sleepM] = sleepTime.split(':').map(Number);
    const [wakeH, wakeM] = wakeTime.split(':').map(Number);
    let sleepDT = new Date();
    sleepDT.setHours(sleepH, sleepM, 0, 0);
    let wakeDT = new Date();
    wakeDT.setHours(wakeH, wakeM, 0, 0);
    if (wakeDT <= sleepDT) wakeDT.setDate(wakeDT.getDate() + 1);
    const diffMs = wakeDT - sleepDT;
    const hours = diffMs / (1000 * 60 * 60);

    await openDB();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const record = { date: today, sleepTime, wakeTime, notes, hours: hours.toFixed(2) };
    store.put(record);
    tx.oncomplete = () => {
      alert('تم حفظ البيانات.');
      calculateSleep();
      renderLog();
    };
    tx.onerror = () => alert('حدث خطأ أثناء حفظ البيانات.');
  }

  // تحميل السجل لليوم الحالي
  async function loadTodayRecord() {
    const today = new Date().toISOString().slice(0, 10);
    await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const req = store.get(today);
      req.onsuccess = () => {
        if (req.result) {
          document.getElementById('sleepTime').value = req.result.sleepTime;
          document.getElementById('wakeTime').value = req.result.wakeTime;
          document.getElementById('dailyNotes').value = req.result.notes;
        }
        resolve(req.result);
      };
      req.onerror = () => reject(req.error);
    });
  }

  // حساب مدة النوم وعرض النصائح
  function calculateSleep() {
    const sleepTime = document.getElementById('sleepTime').value;
    const wakeTime = document.getElementById('wakeTime').value;
    const resultDiv = document.getElementById('sleepResult');
    const adviceDiv = document.getElementById('sleepAdvice');

    if (!sleepTime || !wakeTime) {
      resultDiv.textContent = 'يرجى إدخال وقت النوم ووقت الاستيقاظ';
      adviceDiv.textContent = '';
      return;
    }

    const [sleepH, sleepM] = sleepTime.split(':').map(Number);
    const [wakeH, wakeM] = wakeTime.split(':').map(Number);

    let sleepDT = new Date();
    sleepDT.setHours(sleepH, sleepM, 0, 0);
    let wakeDT = new Date();
    wakeDT.setHours(wakeH, wakeM, 0, 0);
    if (wakeDT <= sleepDT) wakeDT.setDate(wakeDT.getDate() + 1);

    const diffMs = wakeDT - sleepDT;
    const totalHours = diffMs / (1000 * 60 * 60);

    resultDiv.textContent = `مدة النوم: ${totalHours.toFixed(2)} ساعة`;

    let advice = '';
    if (totalHours < 4) {
      advice = 'نصيحة: نوم قليل جداً، حاول النوم لفترة أطول لتحسين صحتك.';
    } else if (totalHours < 6) {
      advice = 'نصيحة: النوم أقل من الموصى به، حاول زيادة عدد ساعات النوم.';
    } else if (totalHours < 8) {
      advice = 'نصيحة: نوم جيد، حافظ عليه.';
    } else if (totalHours <= 10) {
      advice = 'نصيحة: نوم مريح ومناسب.';
    } else {
      advice = 'نصيحة: قد يكون النوم مفرطاً، تأكد من جودة النوم.';
    }
    adviceDiv.textContent = advice;

    if (Notification.permission === 'granted') {
      new Notification('تتبع النوم', {
        body: `مدة نومك اليوم: ${totalHours.toFixed(2)} ساعة`
      });
    }
  }

  // عرض السجل في الجدول
  async function renderLog() {
    const daysToShow = parseInt(document.getElementById('viewRange').value, 10);
    const tbody = document.querySelector('#logTable tbody');
    tbody.innerHTML = '';

    await openDB();

    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);

    const records = [];

    store.openCursor(null, 'prev').onsuccess = function(event) {
      const cursor = event.target.result;
      if (cursor && records.length < daysToShow) {
        records.push(cursor.value);
        cursor.continue();
      } else {
        records.forEach(rec => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${rec.date}</td>
            <td>${rec.sleepTime}</td>
            <td>${rec.wakeTime}</td>
            <td>${rec.hours}</td>
            <td>${escapeHTML(rec.notes || '')}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    };
  }

  // تصدير الملاحظات كملف نصي
  async function exportNotes() {
    await openDB();
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const allNotes = [];

    store.openCursor().onsuccess = function(event) {
      const cursor = event.target.result;
      if (cursor) {
        allNotes.push(`التاريخ: ${cursor.value.date}
ملاحظات:
${cursor.value.notes || ''}
-----------------
`);
        cursor.continue();
      } else {
        const blob = new Blob([allNotes.join('
')], {type: 'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sleep_notes.txt';
        a.click();
        URL.revokeObjectURL(url);
      }
    };
  }

  // حذف ملاحظات اليوم
  async function deleteTodayNotes() {
    const today = new Date().toISOString().slice(0, 10);
    await openDB();

    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const getReq = store.get(today);

    getReq.onsuccess = () => {
      if (!getReq.result) {
        alert('لا توجد ملاحظات لليوم لحذفها.');
        return;
      }
      const updatedRecord = {...getReq.result, notes: ''};
      const putReq = store.put(updatedRecord);
      putReq.onsuccess = () => {
        alert('تم حذف ملاحظات اليوم.');
        document.getElementById('dailyNotes').value = '';
        renderLog();
      };
      putReq.onerror = () => alert('حدث خطأ أثناء الحذف.');
    };
    getReq.onerror = () => alert('حدث خطأ أثناء الوصول إلى البيانات.');
  }

  // حذف جميع الملاحظات (لا تؤثر على أوقات النوم)
  async function deleteAllNotes() {
    if (!confirm('هل أنت متأكد من حذف جميع الملاحظات؟ هذا لا يؤثر على أوقات النوم فقط الملاحظات.')) return;
    await openDB();

    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);

    store.openCursor().onsuccess = function(event) {
      const cursor = event.target.result;
      if (cursor) {
        const record = cursor.value;
        if (record.notes && record.notes.length > 0) {
          const updated = {...record, notes: ''};
          store.put(updated);
        }
        cursor.continue();
      } else {
        alert('تم حذف جميع الملاحظات.');
        document.getElementById('dailyNotes').value = '';
        renderLog();
      }
    };
  }

  // هروب النص لمنع حقن HTML
  function escapeHTML(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, function(m) {
      return {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m];
    });
  }

  // تحميل البيانات عند بدء الصفحة
  window.onload = async () => {
    await loadTodayRecord();
    calculateSleep();
    renderLog();
  };
</script>

</body>
</html>
